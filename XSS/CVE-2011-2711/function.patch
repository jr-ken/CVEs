commit bebe89d7c11a92bf206bf6e528c51ffa8ecbc0d5
Author: Lukas Fleischer <cgit@cryptocrack.de>
Date:   Fri Jul 22 13:47:19 2011 +0200

    Fix potential XSS vulnerability in rename hint
    
    The file name displayed in the rename hint should be escaped to avoid
    XSS. Note that this vulnerability is only applicable when an attacker
    has gained push access to the repository.
    
    Signed-off-by: Lukas Fleischer <cgit@cryptocrack.de>
    Signed-off-by: Lars Hjemli <hjemli@gmail.com>

diff --git a/ui-diff.c b/ui-diff.c
index d21541b..383a534 100644
--- a/ui-diff.c
+++ b/ui-diff.c
@@ -49,73 +49,75 @@ struct diff_filespec *cgit_get_current_new_file(void)
 static void print_fileinfo(struct fileinfo *info)
 {
 	char *class;
 
 	switch (info->status) {
 	case DIFF_STATUS_ADDED:
 		class = "add";
 		break;
 	case DIFF_STATUS_COPIED:
 		class = "cpy";
 		break;
 	case DIFF_STATUS_DELETED:
 		class = "del";
 		break;
 	case DIFF_STATUS_MODIFIED:
 		class = "upd";
 		break;
 	case DIFF_STATUS_RENAMED:
 		class = "mov";
 		break;
 	case DIFF_STATUS_TYPE_CHANGED:
 		class = "typ";
 		break;
 	case DIFF_STATUS_UNKNOWN:
 		class = "unk";
 		break;
 	case DIFF_STATUS_UNMERGED:
 		class = "stg";
 		break;
 	default:
 		die("bug: unhandled diff status %c", info->status);
 	}
 
 	html("<tr>");
 	htmlf("<td class='mode'>");
 	if (is_null_sha1(info->new_sha1)) {
 		cgit_print_filemode(info->old_mode);
 	} else {
 		cgit_print_filemode(info->new_mode);
 	}
 
 	if (info->old_mode != info->new_mode &&
 	    !is_null_sha1(info->old_sha1) &&
 	    !is_null_sha1(info->new_sha1)) {
 		html("<span class='modechange'>[");
 		cgit_print_filemode(info->old_mode);
 		html("]</span>");
 	}
 	htmlf("</td><td class='%s'>", class);
 	cgit_diff_link(info->new_path, NULL, NULL, ctx.qry.head, ctx.qry.sha1,
 		       ctx.qry.sha2, info->new_path, 0);
-	if (info->status == DIFF_STATUS_COPIED || info->status == DIFF_STATUS_RENAMED)
-		htmlf(" (%s from %s)",
-		      info->status == DIFF_STATUS_COPIED ? "copied" : "renamed",
-		      info->old_path);
+	if (info->status == DIFF_STATUS_COPIED || info->status == DIFF_STATUS_RENAMED) {
+		htmlf(" (%s from ",
+		      info->status == DIFF_STATUS_COPIED ? "copied" : "renamed");
+		html_txt(info->old_path);
+		html(")");
+	}
 	html("</td><td class='right'>");
 	if (info->binary) {
 		htmlf("bin</td><td class='graph'>%ld -> %ld bytes",
 		      info->old_size, info->new_size);
 		return;
 	}
 	htmlf("%d", info->added + info->removed);
 	html("</td><td class='graph'>");
 	htmlf("<table summary='file diffstat' width='%d%%'><tr>", (max_changes > 100 ? 100 : max_changes));
 	htmlf("<td class='add' style='width: %.1f%%;'/>",
 	      info->added * 100.0 / max_changes);
 	htmlf("<td class='rem' style='width: %.1f%%;'/>",
 	      info->removed * 100.0 / max_changes);
 	htmlf("<td class='none' style='width: %.1f%%;'/>",
 	      (max_changes - info->removed - info->added) * 100.0 / max_changes);
 	html("</tr></table></td></tr>\n");
 }
 
